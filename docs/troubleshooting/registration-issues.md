# Устранение проблем при регистрации пользователей

## Ошибка "Database error saving new user"

Эта ошибка возникает при регистрации новых пользователей из-за проблемы с триггером базы данных, который должен автоматически создавать записи в таблице `users` после создания записи в таблице `auth.users`.

### Причины ошибки

1. Конфликт уникальности email в таблице `users`
2. Отсутствие правильной обработки исключений в триггере `handle_new_user`
3. Ограничения RLS (Row Level Security) для таблицы `users`

### Временное решение (для пользователей)

В текущей версии приложения мы реализовали временное решение, которое позволяет пользователям успешно регистрироваться, несмотря на эту ошибку:

1. Если вы получаете ошибку "Database error saving new user", попробуйте следующие действия:
   - Убедитесь, что вы используете уникальный email адрес
   - После появления ошибки попробуйте войти с созданными учетными данными
   - Если вход успешен, заполните свой профиль в разделе настроек

2. Если проблема сохраняется, обратитесь в службу поддержки с указанием:
   - Email адреса, который вы пытаетесь зарегистрировать
   - Скриншота ошибки
   - Времени, когда произошла ошибка

### Постоянное решение (для разработчиков)

Для полного исправления проблемы необходимо выполнить следующие действия:

#### Вариант 1: Через интерфейс Supabase (рекомендуемый)

1. Применить SQL-скрипт `scripts/fix_user_trigger.sql` через интерфейс SQL-редактора Supabase:
   - Войдите в Dashboard Supabase проекта
   - Перейдите в раздел SQL Editor
   - Создайте новый запрос и вставьте содержимое файла `scripts/fix_user_trigger.sql`
   - Выполните запрос

2. Скрипт выполняет следующие действия:
   - Обновляет функцию-триггер `handle_new_user` для корректной обработки ошибок
   - Делает поле `email` необязательным в таблице `users`
   - Добавляет индекс для оптимизации поиска по email
   - Проверяет и корректирует настройки RLS
   - Настраивает правильные разрешения для аутентифицированных пользователей

#### Вариант 2: Через скрипты JS API (требуется доступ к Supabase Admin API)

Если у вас есть доступ к Supabase Admin API, вы можете использовать скрипты из папки `scripts/`:

1. Установите зависимости:
   ```bash
   cd scripts
   npm install
   ```

2. Создайте файл `.env` с вашими ключами Supabase:
   ```
   EXPO_PUBLIC_SUPABASE_URL="https://ваш-проект.supabase.co"
   EXPO_PUBLIC_SUPABASE_ANON_KEY="ваш-anon-ключ"
   EXPO_PUBLIC_SUPABASE_SERVICE_ROLE_KEY="ваш-service-role-ключ"
   ```

3. Сгенерируйте токен админа:
   ```bash
   npm run generate-token
   ```

4. Проверьте подключение:
   ```bash
   npm run api:check
   ```

5. Создайте тестового пользователя:
   ```bash
   npm run api:test-register
   ```

Если тестовый пользователь создан успешно, но вы все еще видите ошибку "Database error saving new user", это означает, что триггер не работает корректно. В этом случае, вам нужно выполнить SQL-скрипт через интерфейс Supabase, как описано в Варианте 1.

#### Вариант 3: Обходное решение на клиентской стороне

Если у вас нет возможности изменить структуру базы данных, вы можете использовать обходное решение на клиентской стороне, которое мы уже реализовали в приложении:

1. В коде регистрации добавлена обработка ошибки "Database error saving new user"
2. Если ошибка возникает, но пользователь был успешно создан в системе аутентификации, пользователь перенаправляется на экран успешной регистрации
3. При первом входе пользователя в приложение, дополнительно проверяется наличие записи в таблице `users` и при необходимости она создается

## Альтернативный метод регистрации

Если проблемы с регистрацией сохраняются, администраторы могут создавать пользователей вручную через Supabase Dashboard:

1. Перейдите в раздел Authentication > Users
2. Нажмите "Invite User" или "Add User"
3. Введите email пользователя и временный пароль
4. После создания пользователь получит email с инструкциями для входа

## Мониторинг и логирование

Для отслеживания проблем с регистрацией мы добавили расширенное логирование:

- Все ошибки регистрации записываются в консоль приложения
- Ошибки базы данных фиксируются в логах триггера на стороне Supabase

## Связанные улучшения

В ближайших обновлениях мы планируем реализовать:

1. Асинхронное создание профиля пользователя после успешной регистрации
2. Альтернативные методы аутентификации (Google, Apple)
3. Более детальное логирование ошибок на клиентской стороне 